---
title: "Exploratory analysis"
author: "François Roland"
date: "20 octobre 2015"
output: html_document
---

# Basic data information

```{r, warning=FALSE,message=FALSE}
library(stringr)
library(dplyr)
library(data.table)
library(ggplot2)
library(lubridate)
StormData <- fread("data/StormData.csv")
```

```{r}
dim(StormData)
names(StormData)
```

# Exploratory questions

## How many rows contains `NA` values in data we're interested in?

```{r}
sum(complete.cases(StormData[,.(BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, CROPDMG)]))
```

## What are the different event types?

```{r}
event.types <- unique(StormData[,EVTYPE])
```

So there are `r length(event.types)` different values in the dataset while the
documentation contains only 48 values.

## How many event types are recorded over time?

```{r}
EventTypesOverTime <- StormData %>%
    mutate(year = year(mdy_hms(BGN_DATE)), event_type = factor(tolower(EVTYPE))) %>%
    select(year, event_type) %>%
    group_by(year, event_type) %>%
    summarise(event_count = n())
qplot(year, data = EventTypesOverTime, binwidth = 1)
```

The graph shows that before 1993, there is not a lot of event types recorded.
Thus it is probably wiser to drop data before 1993. The question is not yet
answered completely as we don't have a clue about corrected event types.

# EVTYPE clean up

## How can I map EVTYPE values?

I first have to figure out which values are OK and which are not.
The file even_types.csv has been created by manually collating event types from
StormData_documentation.pdf. It contains 48 values.

```{r evtype_mapping_function}
mapping <- fread("event_types.csv")
mapped.types <- data.table(
    original = event.types,
    cleaned = str_trim(str_to_title(event.types)))
for (key in mapping[,cleaned]) {
    mapped.types <- mapped.types[grep(paste0("^", key, ".*"), cleaned), target := mapping[cleaned == key, target]]
}
setkey(mapped.types, original)
mapped.types[,.N, by = is.na(target)]
StormData <- merge(StormData, mapped.types, all.x = TRUE, by.x = "EVTYPE", by.y = "original")
StormData[,.N, by = is.na(target)]
```

Let's now check the event type histogram after evtype cleanup.

```{r}
EventTypesOverTime <- StormData %>%
    mutate(year = year(mdy_hms(BGN_DATE)), event_type = factor(target)) %>%
    select(year, event_type) %>%
    group_by(year, event_type) %>%
    summarise(event_count = n())
qplot(year, data = EventTypesOverTime, binwidth = 1)
```

Results are very interesting.

I decide to drop data before 1993 because they lack too much records.

```{r}
StormData <- StormData %>%
    mutate(year = year(mdy_hms(BGN_DATE)), event_type = factor(target)) %>%
    select(year, event_type, INJURIES, FATALITIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP) %>%
    filter(year > 1992, !is.na(event_type))
```

