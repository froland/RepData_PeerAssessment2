---
title: "Exploratory analysis"
author: "François Roland"
date: "20 octobre 2015"
output: html_document
---

# Basic data information

```{r, warning=FALSE,message=FALSE}
library(stringr)
library(tidyr)
library(dplyr)
library(data.table)
library(ggplot2)
library(lubridate)
StormData <- fread("data/StormData.csv")
```

```{r}
dim(StormData)
names(StormData) <- tolower(names(StormData))
names(StormData)
```

# Exploratory questions

## How many rows contains `NA` values in data we're interested in?

```{r}
sum(complete.cases(StormData[,.(bgn_date, evtype, fatalities, injuries, propdmg, cropdmg)]))
```

## What are the different event types?

```{r}
event.types <- unique(StormData[,evtype])
```

So there are `r length(event.types)` different values in the dataset while the
documentation contains only 48 values.

## How many event types are recorded over time?

```{r}
EventTypesOverTime <- StormData %>%
    mutate(year = year(mdy_hms(bgn_date)), event_type = factor(tolower(evtype))) %>%
    select(year, event_type) %>%
    group_by(year, event_type) %>%
    summarise(event_count = n())
qplot(year, data = EventTypesOverTime, binwidth = 1)
```

The graph shows that before 1993, there is not a lot of event types recorded.
Thus it is probably wiser to drop data before 1993. The question is not yet
answered completely as we don't have a clue about corrected event types.

# Damage suffixes

First let's check how many different values we get in both -exp columns.

```{r exponent}
property.exponents <- unique(StormData[,propdmgexp])
crop.exponents <- unique(StormData[,cropdmgexp])
unique(c(property.exponents, crop.exponents))
```

From those data, we can build a mapping function.

```{r exponent_mapping}
multiplier <- c('h' = 100, 'k' = 1000, 'm' = 1000000, 'b' = 1000000000)
MapExponentToMultiplier <- function(exponent) {
    ifelse(is.integer(exponent), 10 ^ exponent, multiplier[exponent])
}
mutate(StormData, property.damage.multiplier = MapExponentToMultiplier(propdmgexp),
       crop.damage.multiplier = MapExponentToMultiplier(cropdmgexp))
```


# EVTYPE clean up

## How can I map EVTYPE values?

I first have to figure out which values are OK and which are not.
The file even_types.csv has been created by manually collating event types from
StormData_documentation.pdf. It contains 48 values.

```{r evtype_mapping_function}
mapping <- fread("event_types.csv")
mapped.types <- data.table(
    original = event.types,
    cleaned = str_trim(str_to_title(event.types)))
for (key in mapping[,cleaned]) {
    mapped.types <- mapped.types[grep(paste0("^", key, ".*"), cleaned), target := mapping[cleaned == key, target]]
}
setkey(mapped.types, original)
mapped.types[,.N, by = is.na(target)]
StormData <- merge(StormData, mapped.types, all.x = TRUE, by.x = "evtype", by.y = "original")
StormData[,.N, by = is.na(target)]
```

Let's now check the event type histogram after evtype cleanup.

```{r}
EventTypesOverTime <- StormData %>%
    mutate(year = year(mdy_hms(bgn_date)), event_type = factor(target)) %>%
    select(year, event_type) %>%
    group_by(year, event_type) %>%
    summarise(event_count = n())
qplot(year, data = EventTypesOverTime, binwidth = 1)
StormData <- StormData %>%
    mutate(year = year(mdy_hms(bgn_date)), event_type = factor(target)) %>%
    select(year, event_type, injuries, fatalities, propdmg, propdmgexp, cropdmg, cropdmgexp) %>%
    filter(!is.na(event_type))
names(StormData) <- tolower(names(StormData))
```

Results are very interesting.

In 1992, we've got `r length(unique(StormData[year == 1992, event_type]))` different event types.
In 1993, we've got `r length(unique(StormData[year == 1993, event_type]))` different event types.

Let's check how this translates in terms of human and property damages.

```{r year_explanation}
StormData %>%
    mutate(year.period = ifelse(year > 1992, "After", "Before")) %>%
    group_by(year.period) %>%
    summarise(fatalities.sum = sum(fatalities),
              injuries.sum = sum(injuries),
              property.damage.sum = sum(propdmg),
              crop.damage.sum = sum(cropdmg))
```

I decide to drop data before 1993 because they lack too many event types.

```{r}
StormData <- filter(StormData, year > 1992)
```

# Analysis

## Which event type has the most impact on human lives?

```{r human_impact}
human.impact <- StormData %>%
    select(event_type, fatalities, injuries) %>%
    gather(casualty, frequency, -event_type)
fatalities.by.event_type <- human.impact %>%
    filter(casualty == "fatalities") %>%
    group_by(event_type) %>%
    summarise(frequency.mean = mean(frequency),
              frequency.sum = sum(frequency))

fatalities.mean.top5 <- fatalities.by.event_type %>%
    arrange(desc(frequency.mean)) %>%
    head(n = 5)
fatalities.mean.other <- human.impact %>%
    filter(casualty == "fatalities",
           !(event_type %in% fatalities.mean.top5$event_type)) %>%
    mutate(event_type = "Other") %>%
    group_by(event_type) %>%
    summarise(frequency.mean = mean(frequency),
              frequency.sum = sum(frequency))
fatalities.mean <- rbind(fatalities.mean.top5,
                         fatalities.mean.other)
fatalities.mean

fatalities.sum.top5 <- fatalities.by.event_type %>%
    arrange(desc(frequency.sum)) %>%
    head(n = 5)
fatalities.sum.other <- human.impact %>%
    filter(casualty == "fatalities",
           !(event_type %in% fatalities.sum.top5$event_type)) %>%
    mutate(event_type = "Other") %>%
    group_by(event_type) %>%
    summarise(frequency.mean = mean(frequency),
              frequency.sum = sum(frequency))
fatalities.sum <- rbind(fatalities.sum.top5,
                         fatalities.sum.other)
fatalities.sum
```

## Which event type has the most impact on crops and properties?
